---
title: "Fitting and interpreting models - Exercise"
subtitle: "<br><br> Data Science & Statistics"
author: "Gavin McNicol"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    self_contained: true
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r packages, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(ggtext)
library(knitr)
library(kableExtra)
library(lubridate)
set.seed(1234)
options(dplyr.print_min = 10, dplyr.print_max = 6)
theme_bw <- theme_bw() + theme(axis.text=element_text(size=20),
                               axis.title = element_text(size = 20))
```


```{r message=FALSE}
monroe_fluxes <- read_csv("data/amf-us-mms.csv", na = c("-9999"), skip = 2)
```

```{r echo = F}
monroe_fluxes <- monroe_fluxes %>% 
  select(timestamp = TIMESTAMP_END, 
         fco2 = FC_1_1_1,
         ustar = USTAR_1_1_1, 
         ta = TA_1_1_1, 
         le = LE_1_1_1,
         p = P_1_1_1,
         sw_in = SW_IN_1_1_1,
         rh = RH_1_1_1,
         pa = PA_1_1_1,
      ) 

monroe_fluxes <- monroe_fluxes %>% 
  mutate(date = ymd_hm(timestamp)) %>%
  relocate(date) %>% 
  select(-timestamp)
```


## Warm-up

Using **formula syntax** 

```{r fit-model, eval = F}
linear_reg() %>%
  set_engine("lm") %>%
  fit(fco2 ~ sw_in, data = monroe_fluxes)
```
    
    
    
1. Mark the **dependent** variable and the **explanatory** variable.  
    
2. What is the **package** we use for fitting tidy models?  


---

## Interpreting model coefficients

```{r fit-model2, eval = T, echo = F}
linear_reg() %>%
  set_engine("lm") %>%
  fit(fco2 ~ sw_in, data = monroe_fluxes)
```
  
  
1. In the output above, which value corresponds to the value of y when **x=0**?  

2. Which value is a **slope coefficient**?  
    
2. Does fco2 become **more positive or more negative** as sw_in increases?  
    
3. What **additional line of code** could you add to improve the output of the model fit?  

---

## Identifying model function components

The general form of the linear model function we just explored for `fco2` is:

$$\hat{y}_{i} = b_0 + b_1~x_{i}$$
  
  
1. Add the following labels to the function above: **(1)** slope coefficient, **(2)** predicted value of dependent variable, **(3)** observed value of explanatory variable, and **(4)** y-intercept  
  
  
2. The b's in the function above are sometimes written as $\beta$s. Why are they **b's** rather than 	$\beta$s here?  

---

## Identifying components of a model visualization

```{r vis-res-1, echo=FALSE, fig.height = 6}
fco2_swin_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(fco2 ~ sw_in, data = filter(monroe_fluxes, date > "2020-07-01" & date < "2020-07-05"))

fco2_swin_fit_tidy <- tidy(fco2_swin_fit$fit) 
fco2_swin_fit_aug  <- augment(fco2_swin_fit$fit) %>%
  mutate(res_cat = ifelse(.resid > 0, TRUE, FALSE))

p <- ggplot(data = fco2_swin_fit_aug, 
            aes(x = sw_in, y = fco2)) +
  geom_point(alpha = 0.2) + 
  labs(
    title = "Half-hourly CO2 flux vs. incoming solar radiation",
    subtitle = "For 2020, at Morgan Monroe State Forest",
    x = expression("Radiation (W m"^{-2}*")"),
    y =  expression("Net CO"[2]*" Flux (nmol m"^{-2}*" s"^{-1}*")")) +
  theme(plot.subtitle = element_text(colour = "#E48957", face = "bold", size = rel(1.5)))
p +
  theme_bw
```
    
    
1. Draw and label the following components on the figure above: **(1)** a linear model fit between `fco2` and `sw_in`, **(2)** a few predicted values of `fco2` given observed values of `sw_in`, and **(3)** residuals for `fco2` observations that correspond with those observed values of `sw_in`.




