---
title: "Great Lakes fishing and stocking - data wrangling"
author: "Gavin McNicol"
output: github_document
---

```{r github-auth-2, echo = FALSE, out.width="50%", fig.cap = "Young fish being discharged from pipe"}
knitr::include_graphics("img/stocking.jpeg")
```

```{r load-pkg, message = FALSE}
library(tidyverse)
library(skimr)
```

## Data

The data for this exercise come from the [Great Lakes Database](http://www.glfc.org/great-lakes-databases.php) which provides information about fish caught annually (annual fish catches) in the Great Lakes (Michigan, Huron, Superior, Erie, Ontario) for the last \~150 years.
The Great Lakes have been hit by numerous major ecological changes during this period, including invasion by alewife herring (1950s), introduction of pacific salmon (e.g., chinook; 1970s), and later invasion by quagga and zebra mussels (1990s).
If you're interested in this topic I would recommend the book *The Death and Life of the Great Lakes* by Dan Egan.

```{r load-data, message = FALSE, warning = FALSE}
# From TidyTuesday: https://github.com/rfordatascience/tidytuesday/blob/master/data/2021/2021-06-08/readme.md
fishing <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-08/fishing.csv')
```

## Exercises

**Remember, for ungraded class exercises such as these, just complete the code chunks in this document and knit. Don't commit or push your changes. You're all working from the same repo.**

### Exercise 1.

Warm up!
Take a look at an overview of the first dataset `fishing` with the `skim()` function.

**Note:** I already gave you the answers to this exercise.
You just need to knit the document and view the output.
A definition of all variables is given in the [Data dictionary] section at the end, though you don't need to familiarize yourself with all variables in order to work through these exercises.

```{r fishing-skim}
skim(fishing)
```

**Note:** Remember you can also use `glimpse()` to take a look at a dataset.

### Exercise 2.

Which species and years are associated with the largest total U.S fish catches from Lake Michigan?

Let's see...

Fill in the blanks for filtering for Great Lakes annual fish catch where the region is from the US (`region` code `"U.S.Total"`) and the lake is Lake Michigan (`lake` code `Michigan`).
Then pipe the results into the `slice_max()` function we have used before, so we can select the 5 years with the largest catch (coded as production `values`).
Note: production `values` are rounded to the nearest thousand pounds.

**Note:** You will need to set `eval=TRUE` in the r code chunk header when you have an answer you want to try out.

```{r largest-catches, eval=FALSE}
fishing %>%
  filter(
    lake ___ "___",
    region ___ "U.S. Total"
    ) %>% 
  slice_max(
    order_by = ___, 
    n = 5
      )
```

**Tip:** If you are working with a large dataset like `fishing`, and there are character class variables (e.g., \`region\`\`), you can quickly see what different character strings (regions) are in the dataset by converting the characters to factors (i.e. categorical data), then looking at the levels.
Here's some code to try:

```{r region-levels}
levels( factor( fishing$region ) )
```

### Exercise 3.

How many very large (at least 10,000,000 lbs) fish catches were there before 1950, and which species were they catching in such large quantities?

**Note:** The `values` data are reported to the nearest whole 1,000 lbs, so add 3 zeros to any number in the `values` column.

In the following chunk, replace

-   `[AT LEAST]` with the logical operator for "at least"
-   `[LESS THAN]` with the logical operator for "less than"
-   `[AND]` with the logical operator for "and"

**Note:** You will need to set `eval=TRUE` when you have an answer you want to try out.

```{r some-children, eval=FALSE}
fishing %>%
  filter(
    region ___ "U.S. Total",
    year [LESS THAN] 1950 [AND] values [AT LEAST] 30000
    )
levels(factor(fishing$species))
```

From here on, we'll continue only using catch data from the "U.S. Total" `region`.
To avoid having to filter each time, let's create a new dataframe `fishing_us` from `fishing` that only includes the data we want:

```{r ustotal-dataframe}
fishing_us <- fishing %>% 
  filter(
    region == "U.S. Total"
  )
```

### Exercise 4.

Do you think annual U.S. fish catches are larger in Lake Michigan now, compared to 1975?

Test your intuition with data...

Using `filter()` determine the largest total U.S. catches from Lake Michigan in the years 2015 and 1975.
Simplify your output by using `select()` to select only `year`, `species`, and `values`.
Although we normally tidy up data by pivoting longer, as a final step, use `pivot_wider()` to allow you to compare the catch in 1975 with that in 2015 in a single row.

```{r 1975-comparison}
# add code here
# pay attention to correctness and code style
```

Was your intuition correct?

### Exercise 5.

Pacific Salmon species started being stocked in the Great lakes during the 1970s, for commercial fishing and to reduce the large `Alewife` populations.
Calculate summary statistics (minimum, mean, median, maximum) for the size of the `Chinook Salmon` catch in Lake Michigan over all available years of data.

**Hint:** In addition to the functions you've used up til now, you'll need to use the `summarize()` function.

**Note:** Don't forget to label your R chunk as well (where it says `label-me-1`).
Your label should be short, informative, and shouldn't include spaces.
It also shouldn't repeat a previous label, otherwise R Markdown will give you an error about repeated R chunk labels.

```{r label-me-1}
# add code here
# pay attention to correctness and code style
```

Look at the median value.
Why could we have predicted the median value without doing the median calculation?
Think about the number of years in the dataset...

### Exercise 6.

Use the maximum catch result you got in the last exercise to identify the `year` the largest `Chinook Salmon` catch was made in Lake Michigan.

Remember to label the chunk again.

```{r label-me-2}
# add code here
# pay attention to correctness and code style
```

### Exercise 7.

In the 1980s, invasive mussel species were introduced to the Great Lakes, likely via ballast water discharges into the Lakes from large vessels.
The mussels went on to radically change the ecology of the Lakes, including causing a collapse in the Great Lakes fisheries.
Sum the total Lake Michigan catch (including all species) in the years 1975, 1985, 1995, 2005, and 2015.

**Hint:** You can filter using a vector of numbers (e.g., c(1, 2, 3, 4)), rather than a single number using `%in%` where you would normally put the logical operator (e.g., `==`).

What does the trend show?
During which 10 year period was the largest change in fish catch?

```{r label-me-3}
# add code here
# pay attention to correctness and code style
```

### Exercise 8.

Repeat the same exercise, but do not filter the data for Lake Michigan.
Instead, calculate the total catch for each of the Great Lakes in the dataset.
To make the trend more readable in table format, use `pivot_wider()` in the last step of your code.

Are the trends the same for all the Great Lakes?

```{r label-me-4}
# add code here
# pay attention to correctness and code style

fishing_us %>% 
  filter(
    year %in% c(1975, 1985, 1995, 2005, 2015)
  ) %>% 
  group_by(lake, year) %>% 
  summarize(total_catch = sum(values, na.rm = TRUE)) %>% 
  pivot_wider(
    names_from = "lake",
    values_from = "total_catch"
  )

```

### Exercise 9.

We are currently only looking at total U.S. catch, however, a large part of Lake Superior and Lake Erie are in Canada.
Repeat the calculation from the previous exercise, but this time, use the original dataset `fishing` and filter for both the `U.S. Total` and `Total Canada (ONT)`.
What changes appear in the results, now that data from Ontario, Canada, are included?

```{r label-me-5}
# add code here
# pay attention to correctness and code style
```

### Exercise 10.

**Wrap up** Look closely at the different character strings used in the `species` data column by running the code chunk below.
Do you think this dataset could be cleaned up more?

**Note:** You will need to set `eval=TRUE` when you have an answer you want to try out.

```{r eval=FALSE}
levels( factor( fishing$species ) )
```

## Data dictionary

Below is the full data dictionary.
Note that it is long (there are lots of variables in the second dataset), but we will be using a limited set of the variables for our analysis.

### fishing.csv

| variable    | class     | description                                                         |
|:------------|:----------|:--------------------------------------------------------------------|
| year        | double    | Year of measurement                                                 |
| lake        | character | Lake Name                                                           |
| species     | character | Species of fish                                                     |
| grand_total | double    | Grand total of observed                                             |
| comments    | character | Comments from the dataset providers                                 |
| region      | character | Region of the US/Canada, note there is some inconsistency           |
| values      | double    | Production amounts have been rounded to the nearest thousand pounds |
