---
title: "Lab 07 - Fitting models`"
author: "RUBRIC"
date: "RUBRIC"
output: html_document
---

### Load packages and data

```{r load-packages, message = FALSE}
library(tidyverse)
library(tidymodels)
library(lubridate)
```

## Exercises

### Exercise 1

## **Half point for filepath, half point for rest of code chunk (MAX 1)**

```{r import-data}
fluxes <- read_csv("lab-07-fitting-models-starter/data/us-mms-simple.csv")
```

### Exercise 2

```{r fix-dates, eval = T}
fluxes <- fluxes %>% 
  mutate(date = mdy_hm(date))
head(fluxes)
```

## **Half point completing dates (MAX 0.5)**

```{r subset-fluxes}
fluxes_subset <- fluxes %>% 
  filter(date > "2020-07-01" & date < "2020-07-08")
head(fluxes_subset, 10) 
```

### Exercise 3

## **Half point for labeled chunk, half point for plot, half point for explanatory var (MAX 1.5)**

```{r exploratory-vis}
fluxes_subset %>% 
  ggplot(aes(evaporation, fco2)) +
  geom_point()
```

### Exercise 4

## **Half point for adding geom_smooth with correct method, half point for uncertainty interpretation (MAX 1)**

```{r exploratory-vis}
fluxes_subset %>% 
  ggplot(aes(evaporation, fco2)) +
  geom_point() +
  geom_smooth(method = "lm")
```

The grey band corresponds to the uncertainty around the model function / slope.

### Exercise 5

## **Half point for completing code chunk, half point for each narrative part (flexible on second) (MAX 1.5)**

```{r fit-a-model, eval = T}
linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ evaporation, data = fluxes_subset) %>% 
  tidy()
```

The first estimate value tells us that the y-intercept of the model is 1.53 (units optional) and the second estimate value tells us that the slope coefficient for the relationship between fco2 and evaporation is -0.061 (negative) for every increment in evaporation rate.

### Exercise 6

## **Half a point for each mutate function completion (MAX 1)**

```{r create-season, eval = T}
fluxes <- fluxes %>% 
      filter(date > "2020-01-01" & date < "2021-01-01") %>% 
     mutate(season = ifelse(date < "2020-04-01", "winter", NA),
            season = ifelse(date < "2020-07-01" & date > "2020-04-01", "spring", season),
            season = ifelse(date < "2020-10-01" & date > "2020-07-01", "summer", season),
            season = ifelse(date < "2020-12-31" & date > "2020-10-01", "fall", season)) %>% 
     mutate(winter = ifelse(season == "winter", 1, 0))
```

### Exercise 7

## **Half a point for completing code chunk, half a point for each interpretation (yintercept+slope (0.5), 2 values vs. many (0.5) for Ex 5) (MAX 1.5)**

```{r fit-a-model-2, eval = T}
linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ factor(winter), data = fluxes) %>% 
  tidy()
```

The first estimate value tells us the y-intercept of the linear model is equal to -2.244 nmol m-2 s-1 and the second estimate value tell us the slope coefficient for the effect of `winter` = 1 or TRUE on fco2 is 3.32 (positive).
Unlike in Exercise 5, where evaporation could take on a large range of values, the `winter` variable we created only takes on the values of 0 or 1, which means the yhat (predicted fco2) can only take on one of two values (a value for non-winter seasons and a value for winter).

### Exercise 8

## **Half a point for completing code chunk, half a point for each interpretation (yintercept+slope (0.5), 4 values (0.5), vs. fall+alphabetical order (0.5)) (MAX 2)**

```{r fit-a-model-3, eval = T}
linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ season, data = fluxes) %>% 
  tidy()
```

The first estimate value tells us the y-intercept of the linear model is equal to 0.839 nmol m-2 s-1, the second estimate value tell us the slope coefficient for the effect of `spring` = 1 or TRUE on fco2 is -3.77 (more negative), the third estimate value tells us the slope coefficient for the effect of `summer` is -6.06 (more negative), and the fourth estimate value tells us the slope coefficient for the effect of `winter` is -2.4 (more negative).

yhat (`predicted fco2`) can take on one of four values (one per season) (extra: as each season get's it own dummy variable which can take on a value of 1 or 0).

`fall` is being used as the baseline season because the season categories are treated as factors and without providing factor ordering R will order them alphabetically.

### Exercise 9

## **Full point for completing code chunk, half a point for each interpretation (categorical required, from numerical originally, two values (0/1), line adjusted by a constant amount) (MAX 2.5)**

```{r fit-a-model-4, eval = T}
linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ incoming_radiation + factor(winter), data = fluxes) %>% 
  tidy()
```

Winter needs to be converted to a factor because we want it to be treated as a categorical variable not a continuous variable.
It is coded as a numerical (double) with values of 0 and 1 initially, so factor will convert these values to factor levels.\
The two lines generated by the model will be parallel because the factor winter can only take on two values (zero or one) therefore each line will be adjusted by a constant amount (zero or +1.66) regardless of the value of the continuous variable.

### Exercise 10

## **Half a point each for prev chunk + interaction term, half a point for each interpretation (interaction effect, slope depends on season) (MAX 2)**

```{r fit-a-model-5, eval = T}
linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ incoming_radiation + factor(winter) + incoming_radiation * factor(winter), data = fluxes) %>% 
  tidy()
```

The fourth estimate is the interaction effect.
It's value tells us that the slope coefficient with incoming radiation depends on season (winter vs. not winter).
When it is winter, the slope will be -0.02 + 0.002 (rather than -0.02 in non-winter seasons).

### Exercise 11

## **Half point for first model object, full point for second (same split as ex10). Half point for second model ID (MAX 2)**

```{r fit-two-models-to-objects, eval = T}
fco2_fit_main <- linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ incoming_radiation + factor(winter), data = fluxes) 

fco2_fit_int <- linear_reg() %>% 
  set_engine("lm") %>% 
  fit(fco2 ~ incoming_radiation + factor(winter) + incoming_radiation * factor(winter), data = fluxes) 
```

The second model includes an interaction effect

### Exercise 12

## **Half a point for completing the code chunk; half point for \$ sign, half point each for correct numerical comparison and IDing the better model; half point each for explaining that model fit increases with more terms/explantory variables, that r-squared does not account for that, that adj-r-squared does (MAX 3)**

```{r compare-two-fits, eval = T}
glance(fco2_fit_main)$adj.r.squared
glance(fco2_fit_int)$adj.r.squared
```

The dollar sign is used to select the ad.r.squared variable from the object generated by `glance(model_object)`\
Based on this output the model including the interaction term explains more of the variability in the data (53% vs. 45%), and is therefore a better model.\
Rw tends to increase whenever new terms or explanatory variables are added
. If we had compared `r.squared` values, we could not be sure that the increase was not simply due to adding more terms to the model
. Adjusted R squared already accounts for this effect
.
